FROM node:20-alpine AS builder

ARG ARG_DISABLE_ESLINT_PLUGIN='true'
ARG ARG_TS_IGNORE_BUILD_ERRORS='true'
ARG ARG_TZ
ARG ARG_BACKEND_URL
ARG ARG_JWT_SECRET_KEY
ARG ARG_PUBLIC_URL
ARG ARG_NEXT_PUBLIC_BASENAME
ARG ARG_NEXT_PUBLIC_FILES_PATH
ARG ARG_NEXT_PUBLIC_MAPBOX_TOKEN
ARG ARG_NEXT_PUBLIC_SITE_KEY
ARG ARG_NEXT_PUBLIC_MATOMO_URL
ARG ARG_NEXT_PUBLIC_MATOMO_SITE_ID
ARG ARG_NEXT_PUBLIC_FACEBOOK_PIXEL

ENV DISABLE_ESLINT_PLUGIN=$ARG_DISABLE_ESLINT_PLUGIN
ENV TS_IGNORE_BUILD_ERRORS=$ARG_TS_IGNORE_BUILD_ERRORS
ENV TZ=$ARG_TZ
ENV BACKEND_URL=$ARG_BACKEND_URL
ENV JWT_SECRET_KEY=$ARG_JWT_SECRET_KEY
ENV PUBLIC_URL=$ARG_PUBLIC_URL
ENV NEXT_PUBLIC_BASENAME=$NEXT_PUBLIC_BASENAME
ENV NEXT_PUBLIC_FILES_PATH=$ARG_NEXT_PUBLIC_FILES_PATH
ENV NEXT_PUBLIC_MAPBOX_TOKEN=$ARG_NEXT_PUBLIC_MAPBOX_TOKEN
ENV NEXT_PUBLIC_SITE_KEY=$ARG_NEXT_PUBLIC_SITE_KEY
ENV NEXT_PUBLIC_MATOMO_URL=$ARG_NEXT_PUBLIC_MATOMO_URL
ENV NEXT_PUBLIC_MATOMO_SITE_ID=$ARG_NEXT_PUBLIC_MATOMO_SITE_ID
ENV NEXT_PUBLIC_FACEBOOK_PIXEL=$ARG_NEXT_PUBLIC_FACEBOOK_PIXEL

WORKDIR "/app"

RUN npm install -g npm@9.6.6

RUN printenv > .env
RUN chown node:node .env

COPY --chown=node:node . .
RUN npm ci --force
RUN npm run build

FROM node:20-alpine AS production

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

RUN apk add --no-cache tini

WORKDIR "/app"

COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/package-lock.json ./package-lock.json
COPY --from=builder /app/next.config.js ./next.config.js
COPY --from=builder /app/.env ./.env

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules

EXPOSE 8081

ENTRYPOINT ["/sbin/tini", "--"]

CMD ["sh", "-c", "npm run start"]
